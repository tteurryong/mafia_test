<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì‹±ê¸€ í”Œë ˆì´ì–´ ë§ˆí”¼ì•„ ê²Œì„</title>
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: 'Malgun Gothic', sans-serif;
    margin: 0; padding: 20px;
    display: flex; justify-content: center;
  }
  #game {
    max-width: 600px;
    width: 100%;
  }
  h1 {
    text-align: center;
    margin-bottom: 10px;
  }
  #setup {
    text-align: center;
    margin-bottom: 20px;
  }
  select, button {
    padding: 8px 12px;
    margin: 5px;
    border-radius: 5px;
    border: none;
    background: #333;
    color: #eee;
    cursor: pointer;
  }
  button:hover, select:hover {
    background: #555;
  }
  #messages {
    background: #222;
    border-radius: 8px;
    padding: 15px;
    min-height: 200px;
    max-height: 350px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 15px;
  }
  #players {
    margin-top: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  .player {
    padding: 8px 14px;
    border-radius: 6px;
    user-select: none;
    cursor: default;
    background: #444;
    color: #eee;
    min-width: 50px;
    text-align: center;
  }
  .player.alive {
    background: #28a745;
    cursor: default;
  }
  .player.dead {
    background: #6c757d;
    text-decoration: line-through;
    color: #aaa;
  }
  .player.you {
    border: 2px solid #ffc107;
  }
  #inputSection {
    margin-top: 20px;
    text-align: center;
  }
  #inputSection button {
    min-width: 90px;
  }
</style>
</head>
<body>
<div id="game">
  <h1>ì‹±ê¸€ í”Œë ˆì´ì–´ ë§ˆí”¼ì•„ ê²Œì„</h1>
  <div id="setup">
    <label>ì°¸ê°€ ì¸ì› ìˆ˜: 
      <select id="playerCount"></select>
    </label>
    <button id="startBtn">ê²Œì„ ì‹œì‘</button>
  </div>
  <div id="messages"></div>
  <div id="players"></div>
  <div id="inputSection"></div>
</div>

<!-- ë°°ê²½ìŒì•… -->
<audio id="bgm" src="https://cdn.pixabay.com/download/audio/2022/02/08/audio_2c0c0c2a3d.mp3?filename=chill-vibes-13902.mp3" loop autoplay></audio>

<script>
  // DOM ìš”ì†Œ
  const playerCountSelect = document.getElementById('playerCount');
  const startBtn = document.getElementById('startBtn');
  const messages = document.getElementById('messages');
  const playersDiv = document.getElementById('players');
  const inputSection = document.getElementById('inputSection');

  // ì°¸ê°€ ì¸ì› ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸° (3~12ëª…)
  for(let i=3; i<=12; i++) {
    let opt = document.createElement('option');
    opt.value = i;
    opt.textContent = i + 'ëª…';
    playerCountSelect.appendChild(opt);
  }

  // ê²Œì„ ìƒíƒœ ê°ì²´
  let gameState = {};

  // ì—­í•  ë°°ë¶„ í•¨ìˆ˜
  function assignRoles(n) {
    const mafiaCount = Math.max(1, Math.floor(n / 4));
    const roles = [];
    for(let i=0; i<mafiaCount; i++) roles.push('ë§ˆí”¼ì•„');
    if(n >= 6) {
      roles.push('ì˜ì‚¬');
      roles.push('ê²½ì°°');
    }
    while(roles.length < n) roles.push('ì‹œë¯¼');
    for(let i=roles.length-1; i>0; i--) {
      let j = Math.floor(Math.random() * (i+1));
      [roles[i], roles[j]] = [roles[j], roles[i]];
    }
    return roles;
  }

  // ë©”ì‹œì§€ ì¶œë ¥, clear=trueë©´ ì´ˆê¸°í™”
  function log(text, clear=false) {
    if(clear) messages.textContent = '';
    messages.textContent += text + '\n';
    messages.scrollTop = messages.scrollHeight;
  }

  // í”Œë ˆì´ì–´ UI ë Œë”ë§
  function renderPlayers() {
    playersDiv.innerHTML = '';
    gameState.players.forEach(p => {
      const div = document.createElement('div');
      div.classList.add('player');
      div.textContent = (p.id+1) + (p.id === 0 ? ' (ë‹¹ì‹ )' : '');
      div.classList.add(p.alive ? 'alive' : 'dead');
      if(p.id === 0) div.classList.add('you');
      playersDiv.appendChild(div);
    });
  }

  // ì‚´ì•„ìˆëŠ” í”Œë ˆì´ì–´ ë°˜í™˜
  function alivePlayers() {
    return gameState.players.filter(p => p.alive);
  }

  // ê²Œì„ ì‹œì‘
  startBtn.onclick = () => {
    const n = parseInt(playerCountSelect.value);
    if(isNaN(n) || n < 3 || n > 12) {
      alert('3ëª… ì´ìƒ 12ëª… ì´í•˜ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    startGame(n);
  };

  function startGame(n) {
    const roles = assignRoles(n);
    gameState = {
      players: roles.map((r,i) => ({id:i, role:r, alive:true})),
      phase: 'night',
      day: 0,
      night: 0,
      nightActions: {},
      playerVote: null,
      policeKnown: {}, // ê²½ì°° ì¡°ì‚¬ ê²°ê³¼ ì €ì¥
    };
    log('ê²Œì„ ì‹œì‘!\në‹¹ì‹ ì€ 1ë²ˆ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤. ì—­í• ì€ ë¹„ë°€ì…ë‹ˆë‹¤.\n', true);
    renderPlayers();
    setTimeout(nightPhase, 1500);
  }

  // ë°¤ ë‹¨ê³„
  function nightPhase() {
    gameState.night++;
    gameState.nightActions = { mafiaKill: null, doctorSave: null, policeCheck: null };
    log(`\nğŸŒ™ ë°¤ ${gameState.night}ì¼ì°¨ ì‹œì‘`);

    const me = gameState.players[0];
    inputSection.innerHTML = '';

    if(!me.alive) {
      log('ë‹¹ì‹ ì€ ì£½ì—ˆìŠµë‹ˆë‹¤. ë°¤ í–‰ë™ ë¶ˆê°€.');
      setTimeout(aiNightActions, 1500);
      return;
    }

    if(me.role === 'ë§ˆí”¼ì•„') {
      log('ë‹¹ì‹ ì€ ë§ˆí”¼ì•„ì…ë‹ˆë‹¤. ëˆ„êµ¬ë¥¼ ì£½ì¼ì§€ ì„ íƒí•˜ì„¸ìš”.');
      setupTargetSelection('mafiaKill', false);
    } else if(me.role === 'ì˜ì‚¬') {
      log('ë‹¹ì‹ ì€ ì˜ì‚¬ì…ë‹ˆë‹¤. ëˆ„êµ¬ë¥¼ ì‚´ë¦´ì§€ ì„ íƒí•˜ì„¸ìš”.');
      setupTargetSelection('doctorSave', true);
    } else if(me.role === 'ê²½ì°°') {
      log('ë‹¹ì‹ ì€ ê²½ì°°ì…ë‹ˆë‹¤. ëˆ„êµ¬ë¥¼ ì¡°ì‚¬í• ì§€ ì„ íƒí•˜ì„¸ìš”.');
      setupTargetSelection('policeCheck', false);
    } else {
      log('ë‹¹ì‹ ì€ ì‹œë¯¼ì…ë‹ˆë‹¤. ë°¤ì—ëŠ” í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
      setTimeout(aiNightActions, 1500);
    }
  }

  // íƒ€ê²Ÿ ì„ íƒ UI ì„¸íŒ…
  function setupTargetSelection(actionKey, allowSelf) {
    const alive = alivePlayers();
    inputSection.innerHTML = '';
    alive.forEach(p => {
      if(!allowSelf && p.id === 0) return;
      const btn = document.createElement('button');
      btn.textContent = (p.id+1) + 'ë²ˆ í”Œë ˆì´ì–´';
      btn.onclick = () => {
        gameState.nightActions[actionKey] = p.id;
        inputSection.innerHTML = '';
        log(`ì„ íƒ ì™„ë£Œ: ${p.id+1}ë²ˆ í”Œë ˆì´ì–´`);
        setTimeout(aiNightActions, 1000);
      };
      inputSection.appendChild(btn);
    });
  }

  // AI í–‰ë™ ìˆ˜í–‰ (ë°¤)
  function aiNightActions() {
    // ë§ˆí”¼ì•„ AI í–‰ë™
    if(!gameState.nightActions.mafiaKill) {
      const mafiaAI = gameState.players.filter(p => p.alive && p.role === 'ë§ˆí”¼ì•„' && p.id !== 0);
      if(mafiaAI.length > 0) {
        // ì˜ì‚¬ ë³´í˜¸ ì•ˆë°›ëŠ” ì‚¬ëŒ ì¤‘ ëœë¤
        let targets = gameState.players.filter(p => p.alive && p.role !== 'ë§ˆí”¼ì•„');
        if(targets.length > 0) {
          gameState.nightActions.mafiaKill = targets[Math.floor(Math.random() * targets.length)].id;
          log(`AI ë§ˆí”¼ì•„ê°€ ${gameState.nightActions.mafiaKill+1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ê³µê²© í›„ë³´ë¡œ ì„ ì •`);
        }
      }
    }
    // ì˜ì‚¬ AI í–‰ë™: ì‚´ë¦´ ì‚¬ëŒ ì¤‘ì— ëœë¤, ë³¸ì¸ í¬í•¨ ê°€ëŠ¥
    if(!gameState.nightActions.doctorSave) {
      const doctorAI = gameState.players.filter(p => p.alive && p.role === 'ì˜ì‚¬' && p.id !== 0);
      if(doctorAI.length > 0) {
        const candidates = gameState.players.filter(p => p.alive);
        gameState.nightActions.doctorSave = candidates[Math.floor(Math.random() * candidates.length)].id;
        log(`AI ì˜ì‚¬ê°€ ${gameState.nightActions.doctorSave+1}ë²ˆ í”Œë ˆì´ì–´ ì¹˜ë£Œ í›„ë³´ë¡œ ì„ ì •`);
      }
    }
    // ê²½ì°° AI í–‰ë™: ì¡°ì‚¬ ëŒ€ìƒ ì„ ì • (ë³¸ì¸ ì œì™¸)
    if(!gameState.nightActions.policeCheck) {
      const policeAI = gameState.players.filter(p => p.alive && p.role === 'ê²½ì°°' && p.id !== 0);
      if(policeAI.length > 0) {
        const candidates = gameState.players.filter(p => p.alive && p.id !== 0);
        gameState.nightActions.policeCheck = candidates[Math.floor(Math.random() * candidates.length)].id;
        log(`AI ê²½ì°°ì´ ${gameState.nightActions.policeCheck+1}ë²ˆ í”Œë ˆì´ì–´ ì¡°ì‚¬ í›„ë³´ë¡œ ì„ ì •`);
      }
    }
    setTimeout(resolveNightActions, 2000);
  }

  // ë°¤ í–‰ë™ ê²°ê³¼ ì²˜ë¦¬
  function resolveNightActions() {
    const { mafiaKill, doctorSave, policeCheck } = gameState.nightActions;

    if(mafiaKill !== doctorSave) {
      gameState.players[mafiaKill].alive = false;
      log(`\n${mafiaKill+1}ë²ˆ í”Œë ˆì´ì–´ê°€ ë°¤ì— ì£½ì—ˆìŠµë‹ˆë‹¤.`);
    } else {
      log(`\nì˜ì‚¬ê°€ ${doctorSave+1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ì¹˜ë£Œí•´ ìƒì¡´í–ˆìŠµë‹ˆë‹¤.`);
    }

    if(policeCheck !== null) {
      const role = gameState.players[policeCheck].role;
      gameState.policeKnown[policeCheck] = role === 'ë§ˆí”¼ì•„';
      log(`ê²½ì°°ì´ ${policeCheck+1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ì¡°ì‚¬í–ˆìŠµë‹ˆë‹¤: ${role === 'ë§ˆí”¼ì•„' ? 'ë§ˆí”¼ì•„ ë§ìŒ' : 'ë§ˆí”¼ì•„ ì•„ë‹˜'}`);
    }

    renderPlayers();

    if(checkWin()) {
      endGame();
    } else {
      setTimeout(dayPhase, 3000);
    }
  }

  // ë‚® ë‹¨ê³„
  function dayPhase() {
    gameState.day++;
    log(`\nâ˜€ ë‚® ${gameState.day}ì¼ì°¨ ì‹œì‘`);
    log('ìƒì¡´ìë“¤ì€ ë§ˆí”¼ì•„ë¥¼ ì°¾ì•„ë‚´ê¸° ìœ„í•´ íˆ¬í‘œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');
    renderPlayers();
    setupVote();
  }

  // ë‚® íˆ¬í‘œ UI ì„¸íŒ… (ì²˜í˜• ì•ˆí•¨ í¬í•¨)
  function setupVote() {
    const me = gameState.players[0];
    inputSection.innerHTML = '';

    if(!me.alive) {
      log('ë‹¹ì‹ ì€ ì£½ì–´ì„œ íˆ¬í‘œ ë¶ˆê°€ëŠ¥. AI íˆ¬í‘œ ì§„í–‰í•©ë‹ˆë‹¤.');
      setTimeout(aiVote, 1500);
      return;
    }

    const alive = alivePlayers().filter(p => p.id !== 0);

    inputSection.innerHTML = '<p>ëˆ„êµ¬ë¥¼ ì²˜í˜•í• ê¹Œìš”? (ë³¸ì¸ ì œì™¸, ì²˜í˜• ì•ˆí•¨ ê°€ëŠ¥)</p>';

    alive.forEach(p => {
      const btn = document.createElement('button');
      btn.textContent = (p.id+1) + 'ë²ˆ í”Œë ˆì´ì–´';
      btn.onclick = () => {
        inputSection.innerHTML = '';
        log(`ë‹¹ì‹ ì€ ${p.id+1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.`);
        processVote(p.id);
      };
      inputSection.appendChild(btn);
    });

    // ì²˜í˜• ì•ˆí•¨(íˆ¬í‘œ íŒ¨ìŠ¤) ë²„íŠ¼
    const passBtn = document.createElement('button');
    passBtn.textContent = 'ì²˜í˜• ì•ˆí•¨ (íˆ¬í‘œ íŒ¨ìŠ¤)';
    passBtn.onclick = () => {
      inputSection.innerHTML = '';
      log('ë‹¹ì‹ ì€ ì²˜í˜•í•˜ì§€ ì•Šê¸°ë¡œ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.');
      processVote(null); // nullì€ íŒ¨ìŠ¤
    };
    inputSection.appendChild(passBtn);
  }

  // ë‚® íˆ¬í‘œ ì²˜ë¦¬
  function processVote(playerVoted) {
    const votes = {};

    // ë‚´ íˆ¬í‘œ (playerVotedê°€ nullì´ë©´ íŒ¨ìŠ¤ íˆ¬í‘œ)
    if(playerVoted === null) {
      votes['pass'] = 1;
    } else {
      votes[playerVoted] = 1;
    }

    // AI íˆ¬í‘œ
    const alive = alivePlayers().filter(p => p.id !== 0);
    alive.forEach(p => {
      const candidates = alive.filter(x => x.id !== p.id);
      // AIë„ ì²˜í˜• ì•ˆí•¨ íˆ¬í‘œ ê°€ëŠ¥ (10% í™•ë¥ )
      let voteOptions = [...candidates.map(x => x.id), 'pass'];
      let voteWeights = voteOptions.map(opt => {
        if(opt === 'pass') return 0.1; // 10% í™•ë¥ ë¡œ íŒ¨ìŠ¤
        const pl = gameState.players.find(p => p.id === opt);
        if(p.role === 'ë§ˆí”¼ì•„') {
          // ë§ˆí”¼ì•„ëŠ” ì‹œë¯¼ ìš°ì„  ì²˜í˜• í›„ë³´ë¡œ
          return pl.role !== 'ë§ˆí”¼ì•„' ? 1.0 : 0.1;
        } else {
          // ì‹œë¯¼ì€ ë¬´ì‘ìœ„ ê· ë“± í™•ë¥ 
          return 1.0;
        }
      });

      // ê°€ì¤‘ì¹˜ì— ë”°ë¥¸ ëœë¤ ì„ íƒ í•¨ìˆ˜
      function weightedRandom(options, weights) {
        let sum = weights.reduce((a,b) => a+b, 0);
        let r = Math.random()*sum;
        for(let i=0; i<options.length; i++) {
          r -= weights[i];
          if(r <= 0) return options[i];
        }
        return options[options.length-1];
      }

      const choice = weightedRandom(voteOptions, voteWeights);
      votes[choice] = (votes[choice] || 0) + 1;
    });

    // ìµœë‹¤ ë“í‘œì ì°¾ê¸°
    const maxVotes = Math.max(...Object.values(votes));
    const candidates = Object.keys(votes).filter(k => votes[k] === maxVotes);

    // ë™ì ì´ë©´ ëœë¤ ì„ íƒ
    const executed = candidates[Math.floor(Math.random() * candidates.length)];

    if(executed === '
