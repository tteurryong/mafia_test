<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì‹±ê¸€ë§ˆí”¼ì•„ í…ìŠ¤íŠ¸ ê²Œì„ (ì—­í•  í–‰ë™ í¬í•¨)</title>
<style>
  body { font-family: 'Malgun Gothic', sans-serif; background: #121212; color: #eee; margin: 0; padding: 20px; }
  #game { max-width: 600px; margin: auto; }
  h1 { text-align: center; }
  button { background: #444; border: none; padding: 10px 15px; margin: 5px; color: #eee; cursor: pointer; border-radius: 5px; }
  button:hover { background: #666; }
  #messages { min-height: 150px; background: #222; padding: 15px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; }
  #players { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
  .player { background: #333; padding: 8px 12px; border-radius: 6px; cursor: pointer; user-select: none; }
  .player.alive { background: #28a745; }
  .player.dead { background: #6c757d; text-decoration: line-through; cursor: default; }
  .player.you { border: 2px solid #ffc107; }
  #inputSection { margin-top: 20px; }
  select { padding: 6px 10px; border-radius: 5px; border: none; }
</style>
</head>
<body>
<div id="game">
  <h1>ì‹±ê¸€ë§ˆí”¼ì•„ í…ìŠ¤íŠ¸ ê²Œì„ (ì—­í•  í–‰ë™ í¬í•¨)</h1>

  <div id="setup">
    <label>ì°¸ê°€ ì¸ì› ìˆ˜: 
      <select id="playerCount"></select>
    </label>
    <button id="startBtn">ê²Œì„ ì‹œì‘</button>
  </div>

  <div id="messages"></div>
  <div id="players"></div>
  <div id="inputSection"></div>
</div>

<script>
  // ì—­í•  í• ë‹¹ í•¨ìˆ˜
  const rolesByCount = (n) => {
    let mafiaCount = Math.max(1, Math.floor(n / 4));
    let roles = [];
    roles.push(...Array(mafiaCount).fill("ë§ˆí”¼ì•„"));
    if (n >= 6) {
      roles.push("ì˜ì‚¬");
      roles.push("ê²½ì°°");
    }
    let citizenCount = n - roles.length;
    roles.push(...Array(citizenCount).fill("ì‹œë¯¼"));
    for (let i = roles.length - 1; i > 0; i--) {
      let j = Math.floor(Math.random() * (i + 1));
      [roles[i], roles[j]] = [roles[j], roles[i]];
    }
    return roles;
  };

  const playerCountSelect = document.getElementById("playerCount");
  for(let i=3; i<=12; i++) {
    let opt = document.createElement("option");
    opt.value = i; opt.textContent = i + "ëª…";
    playerCountSelect.appendChild(opt);
  }

  const startBtn = document.getElementById("startBtn");
  const messages = document.getElementById("messages");
  const playersDiv = document.getElementById("players");
  const inputSection = document.getElementById("inputSection");

  let gameState = {};

  function logMessage(text, clear=false) {
    if(clear) messages.textContent = "";
    messages.textContent += text + "\n";
    messages.scrollTop = messages.scrollHeight;
  }

  function renderPlayers() {
    playersDiv.innerHTML = "";
    gameState.players.forEach(p => {
      let div = document.createElement("div");
      div.classList.add("player");
      div.textContent = (p.id + 1) + (p.id === 0 ? " (ë‹¹ì‹ )" : "");
      div.dataset.id = p.id;
      if (p.alive) div.classList.add("alive");
      else div.classList.add("dead");
      if (p.id === 0) div.classList.add("you");
      playersDiv.appendChild(div);
    });
  }

  function getAlive() {
    return gameState.players.filter(p => p.alive);
  }

  startBtn.onclick = () => {
    messages.textContent = "";
    inputSection.innerHTML = "";
    startGame();
  };

  function startGame() {
    let n = parseInt(playerCountSelect.value);
    let roles = rolesByCount(n);
    gameState = {
      players: roles.map((r,i) => ({role:r, alive:true, id:i})),
      phase: 'intro',
      dayCount: 0,
      nightCount: 0,
      playerVote: null,
      nightActions: {mafiaKill:null, doctorSave:null, policeCheck:null},
      policeReport: null,
    };
    logMessage("ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!", true);
    logMessage("ë‹¹ì‹ ì€ 1ë²ˆ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤. ì—­í• ì€ ë¹„ë°€ì…ë‹ˆë‹¤.\n");
    renderPlayers();
    setTimeout(() => nextPhase('night'), 2000);
  }

  function nextPhase(phase) {
    gameState.phase = phase;
    inputSection.innerHTML = "";
    if(phase === 'night') nightPhase();
    else if(phase === 'day') dayPhase();
    else if(phase === 'vote') votePhase();
    else if(phase === 'end') endPhase();
  }

  function nightPhase() {
    gameState.nightCount++;
    gameState.nightActions = {mafiaKill:null, doctorSave:null, policeCheck:null};
    gameState.policeReport = null;
    logMessage(`\nğŸŒ™ ë°¤ ${gameState.nightCount}ì¼ì°¨ê°€ ì‹œì‘ë©ë‹ˆë‹¤.`);

    if(!getAlive().some(p => p.id === 0 && p.alive)) {
      logMessage("ë‹¹ì‹ ì€ ì£½ì—ˆìœ¼ë¯€ë¡œ ë°¤ í–‰ë™ì´ ì—†ìŠµë‹ˆë‹¤.");
      setTimeout(aiNightActions, 1500);
      return;
    }

    let me = gameState.players[0];

    if(me.role === "ë§ˆí”¼ì•„") {
      logMessage("ë‹¹ì‹ ì€ ë§ˆí”¼ì•„ì…ë‹ˆë‹¤. ì£½ì¼ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
      mafiaChooseTarget();
    } else if(me.role === "ì˜ì‚¬") {
      logMessage("ë‹¹ì‹ ì€ ì˜ì‚¬ì…ë‹ˆë‹¤. ì‚´ë¦´ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
      doctorChooseTarget();
    } else if(me.role === "ê²½ì°°") {
      logMessage("ë‹¹ì‹ ì€ ê²½ì°°ì…ë‹ˆë‹¤. ì¡°ì‚¬í•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.");
      policeChooseTarget();
    } else {
      logMessage("ë‹¹ì‹ ì€ ì‹œë¯¼ì…ë‹ˆë‹¤. ë°¤ì—ëŠ” í–‰ë™ì´ ì—†ìŠµë‹ˆë‹¤.");
      setTimeout(aiNightActions, 1500);
    }
  }

  // ì—­í• ë³„ ì„ íƒ UI í•¨ìˆ˜ë“¤
  function mafiaChooseTarget() {
    inputSection.innerHTML = "";
    let targets = getAlive().filter(p => p.role !== "ë§ˆí”¼ì•„");
    targets.forEach(p => {
      let btn = document.createElement("button");
      btn.textContent = `${p.id + 1}ë²ˆ í”Œë ˆì´ì–´`;
      btn.onclick = () => {
        gameState.nightActions.mafiaKill = p.id;
        inputSection.innerHTML = "";
        logMessage(`ë§ˆí”¼ì•„ê°€ ${p.id + 1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ì£½ì´ê¸°ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
        setTimeout(aiNightActions, 1000);
      };
      inputSection.appendChild(btn);
    });
  }

  function doctorChooseTarget() {
    inputSection.innerHTML = "";
    let targets = getAlive();
    targets.forEach(p => {
      let btn = document.createElement("button");
      btn.textContent = `${p.id + 1}ë²ˆ í”Œë ˆì´ì–´`;
      btn.onclick = () => {
        gameState.nightActions.doctorSave = p.id;
        inputSection.innerHTML = "";
        logMessage(`ì˜ì‚¬ê°€ ${p.id + 1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ì‚´ë¦¬ê¸°ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
        setTimeout(aiNightActions, 1000);
      };
      inputSection.appendChild(btn);
    });
  }

  function policeChooseTarget() {
    inputSection.innerHTML = "";
    let targets = getAlive().filter(p => p.id !== 0);
    targets.forEach(p => {
      let btn = document.createElement("button");
      btn.textContent = `${p.id + 1}ë²ˆ í”Œë ˆì´ì–´`;
      btn.onclick = () => {
        gameState.nightActions.policeCheck = p.id;
        inputSection.innerHTML = "";
        logMessage(`ê²½ì°°ì´ ${p.id + 1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ì¡°ì‚¬í•˜ê¸°ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
        setTimeout(aiNightActions, 1000);
      };
      inputSection.appendChild(btn);
    });
  }

  function aiNightActions() {
    let alive = getAlive();

    if(gameState.nightActions.mafiaKill === null) {
      let mafiaAI = alive.filter(p => p.role === "ë§ˆí”¼ì•„" && p.id !== 0);
      if(mafiaAI.length > 0) {
        let targets = alive.filter(p => p.role !== "ë§ˆí”¼ì•„");
        if(targets.length > 0) {
          gameState.nightActions.mafiaKill = targets[Math.floor(Math.random() * targets.length)].id;
          logMessage(`AI ë§ˆí”¼ì•„ê°€ ${gameState.nightActions.mafiaKill + 1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ê³µê²© ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
        }
      }
    }

    if(gameState.nightActions.doctorSave === null) {
      let doctorAI = alive.filter(p => p.role === "ì˜ì‚¬" && p.id !== 0);
      if(doctorAI.length > 0) {
        let targets = alive;
        gameState.nightActions.doctorSave = targets[Math.floor(Math.random() * targets.length)].id;
        logMessage(`AI ì˜ì‚¬ê°€ ${gameState.nightActions.doctorSave + 1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ì¹˜ë£Œ ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
      }
    }

    if(gameState.nightActions.policeCheck === null) {
      let policeAI = alive.filter(p => p.role === "ê²½ì°°" && p.id !== 0);
      if(policeAI.length > 0) {
        let targets = alive.filter(p => p.id !== 0);
        if(targets.length > 0) {
          gameState.nightActions.policeCheck = targets[Math.floor(Math.random() * targets.length)].id;
          logMessage(`AI ê²½ì°°ì´ ${gameState.nightActions.policeCheck + 1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ì¡°ì‚¬ ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`);
        }
      }
    }

    setTimeout(resolveNightActions, 2000);
  }

  function resolveNightActions() {
    const { mafiaKill, doctorSave, policeCheck } = gameState.nightActions;
    if(mafiaKill !== null && mafiaKill !== doctorSave) {
      gameState.players[mafiaKill].alive = false;
      logMessage(`\në°¤ì— ${mafiaKill + 1}ë²ˆ í”Œë ˆì´ì–´ê°€ ì£½ì—ˆìŠµë‹ˆë‹¤.`);
    } else if(mafiaKill !== null && mafiaKill === doctorSave) {
      logMessage(`\nì˜ì‚¬ê°€ ${doctorSave + 1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ì‚´ë ¤ì„œ ì£½ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
    } else {
      logMessage("\në§ˆí”¼ì•„ê°€ ê³µê²©í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }

    if(policeCheck !== null) {
      let isMafia = gameState.players[policeCheck].role === "ë§ˆí”¼ì•„";
      gameState.policeReport = { target: policeCheck, isMafia };
      logMessage(`ê²½ì°°ì´ ${policeCheck + 1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ ì¡°ì‚¬í–ˆìŠµë‹ˆë‹¤.`);
    } else {
      gameState.policeReport = null;
    }

    renderPlayers();

    if(!gameState.players[0].alive) {
      logMessage("\në‹¹ì‹ ì´ ì£½ì—ˆìŠµë‹ˆë‹¤. ê²Œì„ì´ ìë™ ì§„í–‰ë©ë‹ˆë‹¤.");
      setTimeout(() => nextPhase('day'), 2000);
      return;
    }

    if(checkWin()) {
      setTimeout(() => nextPhase('end'), 2000);
    } else {
      setTimeout(() => nextPhase('day'), 2000);
    }
  }

  function dayPhase() {
    gameState.dayCount++;
    logMessage(`\nâ˜€ ë‚® ${gameState.dayCount}ì¼ì°¨ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.`);

    if(gameState.policeReport) {
      const { target, isMafia } = gameState.policeReport;
      logMessage(`ê²½ì°° ì¡°ì‚¬ ê²°ê³¼: ${target + 1}ë²ˆ í”Œë ˆì´ì–´ëŠ” ${isMafia ? "ë§ˆí”¼ì•„" : "ë§ˆí”¼ì•„ê°€ ì•„ë‹™ë‹ˆë‹¤"}.`);
    }

    logMessage("ìƒì¡´ìë“¤ì€ ë§ˆí”¼ì•„ë¥¼ ì°¾ì•„ë‚´ê¸° ìœ„í•´ íˆ¬í‘œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
    renderPlayers();

    if(!gameState.players[0].alive) {
      logMessage("ë‹¹ì‹ ì€ ì£½ì—ˆìœ¼ë¯€ë¡œ íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. AIê°€ íˆ¬í‘œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.");
      setTimeout(() => aiVote(), 1500);
    } else {
      setupVote();
    }
  }

  function setupVote() {
    inputSection.innerHTML = "<p>ëˆ„êµ¬ë¥¼ ì²˜í˜•í• ê¹Œìš”? (ë³¸ì¸ ì œì™¸)</p>";
    let alivePlayers = getAlive().filter(p => p.id !== 0);
    alivePlayers.forEach(p => {
      let btn = document.createElement("button");
      btn.textContent = `${p.id + 1}ë²ˆ í”Œë ˆì´ì–´`;
      btn.onclick = () => playerVote(p.id);
      inputSection.appendChild(btn);
    });
  }

  function playerVote(votedId) {
    gameState.playerVote = votedId;
    inputSection.innerHTML = "";
    logMessage(`ë‹¹ì‹ ì€ ${votedId + 1}ë²ˆ í”Œë ˆì´ì–´ë¥¼ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.`);
    setTimeout(() => aiVote(votedId), 1000);
  }

  function aiVote(playerVoted=null) {
    let votes = {};
    function addVote(id) { votes[id] = (votes[id] || 0) + 1; }

    if(playerVoted !== null) addVote(playerVoted);

    let alivePlayers = getAlive().filter(p => p.id !== 0);

    alivePlayers.forEach(p => {
      if(p.id === 0) return; // ë³¸ì¸ì€ ì´ë¯¸ íˆ¬í‘œí–ˆìŒ
      let candidates = getAlive().filter(x => x.id !== p.id);
      let voteTarget;

      if(p.role === "ë§ˆí”¼ì•„") {
        let nonMafia = candidates.filter(x => x.role !== "ë§ˆí”¼ì•„");
        voteTarget = nonMafia.length ? nonMafia[Math.floor(Math.random() * nonMafia.length)].id : candidates[Math.floor(Math.random() * candidates.length)].id;
      } else {
        // ì‹œë¯¼, ì˜ì‚¬, ê²½ì°°ì€ ëœë¤ íˆ¬í‘œ
        voteTarget = candidates[Math.floor(Math.random() * candidates.length)].id;
      }
      addVote(voteTarget);
    });

    // íˆ¬í‘œ ê²°ê³¼ ì¶œë ¥
    logMessage("\níˆ¬í‘œ ê²°ê³¼:");
    Object.entries(votes).forEach(([id,count]) => {
      logMessage(`${parseInt(id) + 1}ë²ˆ í”Œë ˆì´ì–´: ${count}í‘œ`);
    });

    // ìµœëŒ€ ë“í‘œ ì°¾ê¸°
    let maxVotes = 0;
    let candidates = [];
    for(const [id,count] of Object.entries(votes)) {
      if(count > maxVotes) {
        maxVotes = count;
        candidates = [parseInt(id)];
      } else if(count === maxVotes) {
        candidates.push(parseInt(id));
      }
    }

    // ê³¼ë°˜ìˆ˜ ë˜ëŠ” ë‹¤ìˆ˜ê²° ì²˜ë¦¬ (íˆ¬í‘œì¸ì› ê³¼ë°˜ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ ìµœëŒ€ ë“í‘œì)
    let aliveCount = getAlive().length;
    let executedId = null;

    if(candidates.length === 1) {
      executedId = candidates[0];
    } else {
      // ë™ì ì´ë©´ ë¬´ì²˜í˜•
      logMessage("íˆ¬í‘œê°€ ë™ì ìœ¼ë¡œ ì•„ë¬´ë„ ì²˜í˜•ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }

    if(executedId !== null) {
      gameState.players[executedId].alive = false;
      logMessage(`\n${executedId + 1}ë²ˆ í”Œë ˆì´ì–´ê°€ ì²˜í˜•ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    renderPlayers();

    if(!gameState.players[0].alive) {
      logMessage("\në‹¹ì‹ ì´ ì²˜í˜•ë˜ì–´ ê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.");
      setTimeout(() => nextPhase('end'), 2000);
      return;
    }

    if(checkWin()) {
      setTimeout(() => nextPhase('end'), 2000);
    } else {
      setTimeout(() => nextPhase('night'), 3000);
    }
  }

  function checkWin() {
    let alive = getAlive();
    let mafiaAlive = alive.filter(p => p.role === "ë§ˆí”¼ì•„").length;
    let othersAlive = alive.length - mafiaAlive;

    if(mafiaAlive === 0) {
      logMessage("\nğŸ‰ ì‹œë¯¼íŒ€ì´ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ë§ˆí”¼ì•„ê°€ ëª¨ë‘ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
      return true;
    } else if(mafiaAlive >= othersAlive) {
      logMessage("\nğŸ•µï¸â€â™‚ï¸ ë§ˆí”¼ì•„íŒ€ì´ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ë§ˆí”¼ì•„ê°€ ë™ìˆ˜ ì´ìƒì…ë‹ˆë‹¤.");
      return true;
    }
    return false;
  }

  function endPhase() {
    logMessage("\nê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    inputSection.innerHTML = '<button onclick="location.reload()">ë‹¤ì‹œ ì‹œì‘</button>';
  }
</script>
</body>
</html>
